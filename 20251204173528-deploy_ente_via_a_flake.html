<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>deploy ente via a flake</title>
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="static/styles/org.css"/>
</head>
<body>
<div id="content" class="content">
<h1 class="title">deploy ente via a flake</h1>
<p>
I like ente! And I want it to live in my nixops-managed remote box without Docker. Their deployment story is simple enough that it seems worthwile to make a flake for them and try to upstream it. Here's a quick description of this little project.
</p>
<div id="outline-container-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-package-the-components" class="outline-2">
<h2 id="hd1cf9788-77ed-4bb1-b003-7385d95c4f08-package-the-components">Package the components</h2>
<div class="outline-text-2" id="text-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-package-the-components">
<p>
The ente repository has two projects in it of relevance to us:
</p>
<ul class="org-ul">
<li>web, which contains the yarn-managed nodejs frontend</li>
<li>server, which contains the go module that builds the backend binary</li>
</ul>

<p>
Each of these become ente-web and ente-server in the flake.
</p>

<p>
It mihgt be thecase that we want to package each of the ente-web compoenents separately! That way people don't need to even have the code for frontend components that they don't plan to use.
</p>
</div>
</div>
<div id="outline-container-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-write-a-nixos-module-to" class="outline-2">
<h2 id="hd1cf9788-77ed-4bb1-b003-7385d95c4f08-write-a-nixos-module-to">Write a nixos module to configure and run them</h2>
<div class="outline-text-2" id="text-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-write-a-nixos-module-to">
</div>
<div id="outline-container-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-a-systemd-service-to" class="outline-3">
<h3 id="hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-a-systemd-service-to">Create a systemd service to run the backend</h3>
<div class="outline-text-3" id="text-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-a-systemd-service-to">
<p>
Ente-server expects, according to the doc, to be available to the frontend components at a network address, which in the local default is "<a href="http://localhost:8080">http://localhost:8080</a>". We write a systemd service to run it there.
</p>

<p>
The only surprise is that currently the binary wants our configuration to be available in the working directory from which you run the command. It needs that working directory to contain both <code>./museum.yaml</code> and <code>./configurations/${ENVIRONMENT}.yml</code>.
</p>

<p>
I create a derivation that copies that directory from source into the right place, and also writes a <code>museum.yaml</code> from nix-managed options.
</p>

<p>
There's also an option to just use a <code>museum.yaml</code> file that you provide, which if set overrides the nix-tangled options entirely.
</p>
</div>
</div>
<div id="outline-container-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-an-nginx-configuration-that" class="outline-3">
<h3 id="hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-an-nginx-configuration-that">Create an nginx configuration that serves the frontend</h3>
<div class="outline-text-3" id="text-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-an-nginx-configuration-that">
<p>
This is relatively straightforward; I find their expectation of subdomains in productino a little weird, but don't deny that it must simplify their routes management significantly for each service to be able to expect that they're at root. I wish them whatever ease they can manage, beiung on next.js . My misadventures with rasendubi/braindump still have me salty around all the indirection involved in next.
</p>

<p>
The nginx config can be enabled via a switch, and is a sufficiently canonical format to be easy to adapt to whatever reverse proxy service someone might favor. I guess, since their docs give a Caddy config example, that a Caddy config might also be appropriate.
</p>
</div>
</div>
<div id="outline-container-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-the-nix-options-that" class="outline-3">
<h3 id="hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-the-nix-options-that">Create the nix options that tangle into <code>museum.yaml</code></h3>
<div class="outline-text-3" id="text-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-create-the-nix-options-that">
<p>
The defaults given in <code>config/example.yaml</code> and <code>configurations/local.yaml</code> need to be examined and populated into either the <code>museumConfig</code> local variable (these can be overriden with <code>museumExtraConfig</code>), or as options under <code>config.services.ente.museum</code>. Of particular note: external domain, db, secrets, storage bucket, smtp.
</p>

<p>
azan-n.com wants to try doing this part, since I've convverted him to the nix life. So this will be a coauthored PR! (:
</p>
</div>
</div>
</div>
<div id="outline-container-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-backlinks" class="outline-3">
<h3 id="hd1cf9788-77ed-4bb1-b003-7385d95c4f08-backlinks">Backlinks</h3>
<div class="outline-text-3" id="text-hd1cf9788-77ed-4bb1-b003-7385d95c4f08-backlinks">
</div>
<ul class="org-ul">
<li><a href="index.html#ID-3cf4c0b8-c265-42e5-a6df-3efc6e8944f5">Review</a></li>
<li><a href="20251209184154-fuck_wasm_pack.html#ID-b9fc0cfa-8ec5-4b79-aba9-31234fa99af1">Fuck wasm-pack</a></li>
</ul>
</div>
</div>
<div id="postamble" class="status">
<script data-isso="https://comments.itihas.review/"
        data-isso-css-url="static/styles/isso.css"
        src="https://comments.itihas.review/js/embed.min.js"></script>
<section id="isso-thread">
<noscript>Javascript needs to be activated to view comments.</noscript>
</section>
</div>
</body>
</html>
